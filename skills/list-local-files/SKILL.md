# 文件读取 Skill

## 目的
解决项目中文件读取失败的问题，提供系统化的排查和解决方案。

## 常见问题

### 问题1：文件不存在错误 (ENOENT)
**错误信息**：
```
ENOENT: no such file or directory, access 'C:\...\chapter-15.md'
```

**原因**：
- 文件名格式不正确
- 文件路径错误
- 文件确实不存在

**解决方案**：

#### 步骤1：尝试多种文件名格式
中文小说项目常见的文件名格式：
- `chapter-15.md` / `chapter-0015.md`
- `第15章.md` / `第0015章.md`
- `第15章-章节名.md`
- `第0015章参考.md` （带"参考"后缀）
- `第0015章-参考.md`

**必须逐一尝试**，不要猜测。

#### 步骤2：询问用户确认
如果尝试常见格式都失败，直接询问用户：
> "请告诉我正确的文件路径和文件名，或者直接把文件内容粘贴给我。"

#### 步骤3：使用 Python 列出目录
如果用户不确定文件名，使用 Python 脚本列出目录内容：

```python
import os

path = r'C:\Users\31509\clawd\Project\novel-writing\drafts'

try:
    files = os.listdir(path)
    print(f"目录: {path}")
    print(f"文件数量: {len(files)}")
    print("\n文件列表:")
    for f in files:
        print(f"  {f}")
except Exception as e:
    print(f"错误: {e}")
```

---

### 问题2：目录不存在
**错误信息**：
```
ENOENT: no such file or directory, access 'C:\...\drafts'
```

**解决方案**：
1. 检查路径拼写是否正确
2. 确认目录是否被移动或重命名
3. 询问用户正确的目录位置

---

### 问题3：权限不足
**错误信息**：
```
EACCES: permission denied
```

**解决方案**：
1. 确认文件是否被其他程序占用
2. 询问用户是否有权限访问该文件
3. 尝试复制文件到可访问目录

---

## 成功案例记录

### 案例1：第15章草稿读取
**时间**：2026-02-18
**问题**：无法读取 `drafts/chapter-15.md`
**尝试**：
1. ❌ `chapter-15.md`
2. ❌ `第15章.md`
3. ❌ `第0015章.md`
4. ✅ `第0015章参考.md` （用户提示正确文件名）

**经验**：
- 用户提示的文件名格式必须准确使用
- "参考"后缀容易被忽略

---

## 最佳实践 ⭐ 重要

### 读取小说文件的标准流程（必须遵循）

```
用户要求读取文件夹内的文件
    ↓
【第一步】列出目录内容
    使用 Python os.listdir() 列出文件夹内所有文件
    ↓
【第二步】分析文件列表
    查看有哪些文件，判断最可能匹配的文件名
    ↓
【第三步】读取最匹配的文件
    使用 read 工具读取确定的文件
    ↓
成功 → 返回内容
失败 → 记录错误，询问用户
```

### ❌ 禁止做法

**不要这样做**：
```
用户：看下 drafts 文件夹里的第15章
我：尝试读取 drafts/chapter-15.md （失败）
我：尝试读取 drafts/第15章.md （失败）
我：尝试读取 drafts/第0015章.md （失败）
```

**问题**：盲目猜测文件名，效率低下，可能全部失败

### ✅ 正确做法

**应该这样做**：
```
用户：看下 drafts 文件夹里的第15章
我：先用 Python 列出 drafts 文件夹内容
    → 发现文件：第0012章.md, 第0013章.md, 第0015章参考.md
我：分析：用户要第15章，最匹配的是"第0015章参考.md"
我：读取第0015章参考.md （成功）
```

---

### Python 列出目录脚本模板

```python
import os

path = r'用户提供的文件夹路径'

try:
    files = os.listdir(path)
    print(f"目录: {path}")
    print(f"文件数量: {len(files)}")
    print("\n文件列表:")
    for f in files:
        full_path = os.path.join(path, f)
        if os.path.isfile(full_path):
            size = os.path.getsize(full_path)
            print(f"  {f} ({size} bytes)")
        else:
            print(f"  [DIR] {f}")
except Exception as e:
    print(f"错误: {e}")
```

**执行方式**：将脚本保存到 temp 目录，然后用 exec 执行

---

### 文件匹配判断标准

列出文件后，根据以下条件选择最匹配的文件：

| 用户描述 | 文件列表中有 | 选择 |
|---------|-------------|------|
| "第15章" | 第0015章参考.md | ✅ 第0015章参考.md |
| "草稿" | chapter-15-draft.md | ✅ chapter-15-draft.md |
| "人物设定" | 主角-天力.md, 人物设定.md | 询问用户具体要哪个 |

**原则**：
- 数字匹配优先（15 = 0015）
- 关键词匹配其次（草稿 = draft）
- 多个可能时，询问用户确认

### 文件名格式优先级（中文小说项目）

| 优先级 | 格式示例 | 适用场景 |
|-------|---------|---------|
| 1 | `第0015章.md` | 标准章节文件 |
| 2 | `第0015章-章节名.md` | 带章节名的文件 |
| 3 | `第0015章参考.md` | 草稿/参考文件 |
| 4 | `chapter-15.md` | 英文格式文件 |
| 5 | `第15章.md` | 简写格式 |

---

## 工具使用

### 推荐的读取工具

| 场景 | 推荐工具 | 说明 |
|------|---------|------|
| 已知完整路径 | `read` | 直接读取 |
| 不确定文件名 | Python `os.listdir()` | 列出目录查找 |
| 文件内容大 | `read` + `offset/limit` | 分批读取 |

### 禁止的操作
❌ **不要用 PowerShell 读取文件**
- 中文路径容易乱码
- 输出格式不稳定

✅ **推荐用 Python 处理文件操作**
- `open()` 支持 UTF-8 编码
- `os.listdir()` 列出目录
- `os.path` 处理路径

---

## 关联文件

- `skills/execution-standards/SKILL.md` - 技术操作规范
- `skills/web-search/SKILL.md` - 联网搜索规范

---

**创建时间**：2026-02-18  
**更新记录**：
- 2026-02-18：初始版本，记录第15章读取成功经验
