# Feishu 图片发送最佳实践

## 描述
记录通过飞书发送图片的成功经验和失败教训。

## 发送图片方法

### 使用 message 工具发送图片

```json
{
  "action": "send",
  "filePath": "图片绝对路径",
  "message": " accompanying text"
}
```

### 关键参数

| 参数 | 说明 | 示例 |
|------|------|------|
| `filePath` | 图片文件的绝对路径 | `C:\\Users\\...\\image.png` |
| `message` |  accompanying text（可选） | 描述图片内容 |

## ⚠️ 重要经验教训

### ❌ 严重错误（2026-02-15）

**问题描述**：
- 生成图片后，仅在对话中**展示**了图片（我能看到）
- 但**没有通过飞书发送**（用户看不到）
- 连续两次需要用户提醒后才补发

**根本原因**：
- ❌ **混淆了"展示"和"发送"**：`read` 工具展示图片 ≠ `message` 工具发送图片
- ❌ **遗漏关键步骤**：生成图片后，必须显式调用 `message` 发送
- ❌ **错误假设**：以为"展示给用户看"就等同于"用户收到了"

**正确理解**：
```
我能看到（展示）      用户能看到（发送）
     ↓                      ↓
read 工具              message 工具
内部查看               飞书送达
```

---

### ✅ 成功案例（2026-02-15）

**成功发送示例**：
```json
{
  "action": "send",
  "filePath": "C:\\Users\\31509\\clawd\\Project\\comfyui-setup\\ComfyUI\\output\\hf_gen_20260215_110730.png",
  "message": "🐱 图片生成成功！使用 FLUX.1-schnell 模型生成"
}
```

**成功要点**：
1. 使用 **绝对路径**（`C:\\Users\\...` 格式）
2. 路径中使用 **双反斜杠** `\\` 或 **正斜杠** `/`
3. 确保文件存在且可读
4. 图片格式支持：PNG、JPG、JPEG

### ❌ 失败教训

**常见失败原因**：
1. **路径错误**：使用相对路径可能导致找不到文件
2. **文件不存在**：文件未生成或路径错误
3. **权限问题**：文件被占用或无读取权限
4. **格式不支持**：使用了飞书不支持的图片格式

## 📋 图片处理标准流程

### 生成/获取图片后的必做步骤

```
生成图片 → 验证存在 → 决定动作 → 执行
   ↓           ↓           ↓         ↓
生成文件   检查路径    判断场景    展示或发送
```

**场景 1：仅需自己查看**
- 测试生成效果
- 验证图片内容
- ✅ 使用 `read` 工具查看

**场景 2：需要发送给用户** ⭐ **最常见**
- 生成结果展示
- 设计图分享
- ✅ 必须使用 `message` 工具发送
- ✅ **不能只用 `read` 展示**

### 关键检查点

| 步骤 | 工具 | 目的 | 常见错误 |
|------|------|------|----------|
| 1. 生成 | `exec`/`python` | 创建图片文件 | 路径错误 |
| 2. 验证 | `read` | **确认我可以看到** | 跳过验证 |
| 3. 发送 | `message` | **确保用户收到** | ❌ **遗漏此步** |

### 防错口诀

> **"展示给我看，发送给你用"**
> 
> - 用 `read` = 我自己看（内部验证）
> - 用 `message` = 发送给用户（飞书送达）
> 
> **生成图片后，默认必须发送！**

---

## 发送前检查清单

- [ ] 文件是否存在：`Test-Path 文件路径`
- [ ] 使用绝对路径
- [ ] 文件大小是否合理（不超过飞书限制）
- [ ] 文件格式正确（PNG/JPG/JPEG）
- [ ] **已调用 `message` 发送（不是只 `read` 查看）**

## 示例代码

```powershell
# 检查文件是否存在
if (Test-Path "C:\\path\\to\\image.png") {
    # 发送图片
    message action=send filePath="C:\\path\\to\\image.png" message="图片描述"
} else {
    Write-Error "文件不存在"
}
```

## 总结

### 🎯 核心要点

1. **发送 ≠ 展示**
   - `read` = 我自己看（内部验证）
   - `message` = 用户收到（飞书送达）
   - **默认：生成图片后必须发送给用户！**

2. **路径规范**
   - ✅ 使用绝对路径
   - ✅ 确保文件存在
   - ✅ 使用标准图片格式

3. **用户体验**
   - 添加 accompanying text 说明图片内容
   - 主动发送，不要等用户提醒

### ❌ 血教训（2026-02-15）

| 次数 | 错误 | 后果 |
|------|------|------|
| 第1次 | 生成小猫图后只展示没发送 | 用户提醒后补发 |
| 第2次 | 生成UI图后只展示没发送 | 用户提醒后补发 |

**改进措施**：
- 生成图片后，默认执行 `message` 发送
- 除非明确指令"只给我看"
- 养成"生成→验证→发送"的肌肉记忆

---

**记录时间**：2026-02-15  
**更新记录**：新增"展示≠发送"教训和防错流程
